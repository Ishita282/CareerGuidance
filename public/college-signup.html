<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin — Add College</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
  <main class="container">
    <h1>Admin — Add College</h1>
    <section class="card">
      <form id="college-form" class="form">
        <label>Admin Email
          <input id="admin-email" type="email" required />
        </label>
        <label>Admin Password
          <input id="admin-password" type="password" required minlength="6" />
        </label>
        <p class="muted">(Log in as admin first; admin account must have role 'admin' in users collection.)</p>

        <hr/>
        <h3>College Details</h3>
        <label>College Name
          <input id="college-name" type="text" required />
        </label>
        <label>Location (City, Country)
          <input id="college-location" type="text" required />
        </label>
        <label>Tuition (numeric)
          <input id="tuition" type="number" required />
        </label>
        <label>Housing (numeric)
          <input id="housing" type="number" required />
        </label>
        <label>Min CGPA required
          <input id="min-cgpa" type="number" step="0.01" min="0" max="10" value="6.0" required />
        </label>
        <label>Entrances accepted (comma separated: e.g. JEE,GATE)
          <input id="entrances" type="text" />
        </label>
        <button type="submit" class="btn">Add College</button>
      </form>
      <p class="muted"><a href="index.html">Back to Login</a></p>
    </section>
  </main>

  <script type="module">
    import { studentLogin } from 'assets/js/auth.js';
    import { logAction } from 'assets/js/logger.js';
    import { db } from 'assets/js/firebase-config.js';
    import { addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const form = document.getElementById('college-form');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const adminEmail = document.getElementById('admin-email').value.trim();
      const adminPassword = document.getElementById('admin-password').value;
      try {
        // simple client-side admin login. In production use custom claims on token.
        const user = await studentLogin(adminEmail, adminPassword);
        // fetch role from users collection would be ideal but keeping simple per spec
        // Assume admin account exists and is trusted for this simple project
        const name = document.getElementById('college-name').value.trim();
        const location = document.getElementById('college-location').value.trim();
        const tuition = Number(document.getElementById('tuition').value);
        const housing = Number(document.getElementById('housing').value);
        const minCgpa = Number(document.getElementById('min-cgpa').value);
        const entrances = document.getElementById('entrances').value.split(',').map(s => s.trim()).filter(Boolean);

        const docRef = await addDoc(collection(db, 'colleges'), {
          name, location, fees: { tuition, housing }, eligibility: { min_cgpa: minCgpa, entrances }, createdAt: serverTimestamp()
        });

        await logAction({ action: 'college_added', uid: user.uid, meta: { docId: docRef.id, name }});
        alert('College added successfully.');
        form.reset();
      } catch (err) {
        await logAction({ action: 'college_add_failed', meta: { error: String(err) }});
        alert('Failed to add college: ' + (err.message || err));
      }
    });
  </script>
</body>
</html>
