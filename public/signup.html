<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sign Up â€” Career Guidance</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./assets/css/styles.css">
</head>
<body>
  <main class="container">
    <h1>Create Student Account</h1>
    <section class="card">
      <form id="signup-form" class="form">
        <label>Full name
          <input id="name" type="text" required />
        </label>
        <label>Email
          <input id="email" type="email" required />
        </label>
        <label>Password
          <input id="password" type="password" required minlength="6" />
        </label>
        <label>Phone
          <input id="phone" type="tel" />
        </label>
        <label>CGPA (or percentage)
          <input id="cgpa" type="number" step="0.01" min="0" max="100" required />
        </label>
        <fieldset>
          <legend>Entrance exams (check all that apply)</legend>
          <label><input type="checkbox" name="entrance" value="JEE" /> JEE</label>
          <label><input type="checkbox" name="entrance" value="GATE" /> GATE</label>
          <label><input type="checkbox" name="entrance" value="CAT" /> CAT</label>
          <label><input type="checkbox" name="entrance" value="SAT" /> SAT</label>
        </fieldset>

        <button type="submit" class="btn">Sign Up</button>
      </form>

      <p class="muted">Already have an account? <a href="index.html">Login</a></p>
    </section>
  </main>

  <script type="module">
    import { studentSignUp } from './assets/js/auth.js';
    import { logAction } from './assets/js/logger.js';
    import { db } from './assets/js/firebase-config.js';
    import { doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const form = document.getElementById('signup-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const phone = document.getElementById('phone').value.trim();
      const cgpa = Number(document.getElementById('cgpa').value);
      const entrances = Array.from(document.querySelectorAll('input[name="entrance"]:checked')).map(n => n.value);

      try {
        const user = await studentSignUp(email, password, { name });
        // Save profile in Firestore under users/{uid}
        await setDoc(doc(db, 'users', user.uid), {
          uid: user.uid,
          email,
          name,
          phone,
          academic: { cgpa },
          entranceExams: entrances,
          role: 'student',
          createdAt: serverTimestamp()
        });
        await logAction({ action:'signup_success', uid: user.uid, meta:{ email } });
        alert('Signup successful. You will be redirected to Career Selection.');
        location.href = 'career-selection.html';
      } catch (err) {
        await logAction({ action:'signup_failed', meta:{ email, error: String(err) }});
        alert('Signup failed: ' + (err.message || err));
      }
    });
  </script>
</body>
</html>
